<?php
// ====== ТВОЯ БАЗА КВАРТИР ======
$apartments = [
    ['этаж' => 2, 'номер' => 311, 'площадь' => 106.1, 'вид' => 'Море&Горы', 'цена_м2' => 1400, 'общая_сумма' => 148540, 'статус' => 'Свободный'],
    ['этаж' => 2, 'номер' => 319, 'площадь' => 67.6, 'вид' => 'Горы', 'цена_м2' => 1000, 'общая_сумма' => 67600, 'статус' => 'Свободный'],
    ['этаж' => 2, 'номер' => 306, 'площадь' => 36.6, 'вид' => 'Море', 'цена_м2' => 1450, 'общая_сумма' => 53070, 'статус' => 'Свободный'],
    ['этаж' => 3, 'номер' => 419, 'площадь' => 67.6, 'вид' => 'Горы', 'цена_м2' => 1100, 'общая_сумма' => 74360, 'статус' => 'Свободный'],
    ['этаж' => 3, 'номер' => 412, 'площадь' => 50.3, 'вид' => 'Горы', 'цена_м2' => 1100, 'общая_сумма' => 55330, 'статус' => 'Свободный'],
    ['этаж' => 4, 'номер' => 511, 'площадь' => 106.1, 'вид' => 'Море&Горы', 'цена_м2' => 1650, 'общая_сумма' => 175065, 'статус' => 'Свободный'],
    ['этаж' => 4, 'номер' => 504, 'площадь' => 56.7, 'вид' => 'Море', 'цена_м2' => 1700, 'общая_сумма' => 96390, 'статус' => 'Свободный'],
    ['этаж' => 4, 'номер' => 503, 'площадь' => 56.5, 'вид' => 'Море', 'цена_м2' => 1700, 'общая_сумма' => 96050, 'статус' => 'Свободный'],
    ['этаж' => 4, 'номер' => 519, 'площадь' => 67.6, 'вид' => 'Горы', 'цена_м2' => 1200, 'общая_сумма' => 81120, 'статус' => 'Свободный'],
    ['этаж' => 4, 'номер' => 508, 'площадь' => 37.6, 'вид' => 'Горы', 'цена_м2' => 1850, 'общая_сумма' => 69560, 'статус' => 'Свободный'],
    ['этаж' => 509, 'номер' => 309, 'площадь' => 36.3, 'вид' => 'Море', 'цена_м2' => 1850, 'общая_сумма' => 67110, 'статус' => 'Свободный'],
    ['этаж' => 4, 'номер' => 518, 'площадь' => 34.8, 'вид' => 'Горы', 'цена_м2' => 1200, 'общая_сумма' => 41760, 'статус' => 'Свободный'],
    ['этаж' => 4, 'номер' => 516, 'площадь' => 34.6, 'вид' => 'Горы', 'цена_м2' => 1200, 'общая_сумма' => 41520, 'статус' => 'Свободный'],
    ['этаж' => 4, 'номер' => 514, 'площадь' => 34.2, 'вид' => 'Горы', 'цена_м2' => 1200, 'общая_сумма' => 41040, 'статус' => 'Свободный'],
    ['этаж' => 4, 'номер' => 517, 'площадь' => 34.2, 'вид' => 'Горы', 'цена_м2' => 1200, 'общая_сумма' => 41040, 'статус' => 'Свободный'],
    ['этаж' => 4, 'номер' => 513, 'площадь' => 33.7, 'вид' => 'Горы', 'цена_м2' => 1200, 'общая_сумма' => 40440, 'статус' => 'Свободный'],
    ['этаж' => 5, 'номер' => 611, 'площадь' => 106.1, 'вид' => 'Море&Горы', 'цена_м2' => 1800, 'общая_сумма' => 190980, 'статус' => 'Свободный'],
    ['этаж' => 5, 'номер' => 619, 'площадь' => 67.6, 'вид' => 'Горы', 'цена_м2' => 1300, 'общая_сумма' => 87880, 'статус' => 'Свободный'],
    ['этаж' => 5, 'номер' => 615, 'площадь' => 33.0, 'вид' => 'Горы', 'цена_м2' => 1300, 'общая_сумма' => 42900, 'статус' => 'Свободный'],
    ['этаж' => 5, 'номер' => 616, 'площадь' => 34.2, 'вид' => 'Горы', 'цена_м2' => 1350, 'общая_сумма' => 46170, 'статус' => 'Свободный'],
    ['этаж' => 5, 'номер' => 614, 'площадь' => 34.2, 'вид' => 'Горы', 'цена_м2' => 1350, 'общая_сумма' => 46170, 'статус' => 'Свободный'],
    ['этаж' => 5, 'номер' => 617, 'площадь' => 34.2, 'вид' => 'Горы', 'цена_м2' => 1350, 'общая_сумма' => 44640, 'статус' => 'Свободный'],
    ['этаж' => 5, 'номер' => 613, 'площадь' => 33.7, 'вид' => 'Горы', 'цена_м2' => 1300, 'общая_сумма' => 43810, 'статус' => 'Свободный'],
    ['этаж' => 5, 'номер' => 614, 'площадь' => 34.2, 'вид' => 'Горы', 'цена_м2' => 1300, 'общая_сумма' => 44460, 'статус' => 'Свободный'],
    ['этаж' => 5, 'номер' => 615, 'площадь' => 34.6, 'вид' => 'Горы', 'цена_м2' => 1300, 'общая_сумма' => 44980, 'статус' => 'Свободный'],
    ['этаж' => 5, 'номер' => 616, 'площадь' => 34.6, 'вид' => 'Горы', 'цена_м2' => 1300, 'общая_сумма' => 44980, 'статус' => 'Свободный'],
    ['этаж' => 5, 'номер' => 617, 'площадь' => 34.2, 'вид' => 'Горы', 'цена_м2' => 1300, 'общая_сумма' => 44460, 'статус' => 'Свободный'],
    ['этаж' => 5, 'номер' => 618, 'площадь' => 34.8, 'вид' => 'Горы', 'цена_м2' => 1300, 'общая_сумма' => 45420, 'статус' => 'Свободный'],
    ['этаж' => 5, 'номер' => 619, 'площадь' => 67.6, 'вид' => 'Горы', 'цена_м2' => 1300, 'общая_сумма' => 87880, 'статус' => 'Свободный'],
    ['этаж' => 6, 'номер' => 711, 'площадь' => 106.1, 'вид' => 'Море&Горы', 'цена_м2' => 1900, 'общая_сумма' => 201590, 'статус' => 'Свободный'],
    ['этаж' => 6, 'номер' => 712, 'площадь' => 50.3, 'вид' => 'Горы', 'цена_м2' => 1400, 'общая_сумма' => 70240, 'статус' => 'Свободный'],
    ['этаж' => 6, 'номер' => 713, 'площадь' => 33.7, 'вид' => 'Горы', 'цена_м2' => 1400, 'общая_сумма' => 47280, 'статус' => 'Свободный'],
    ['этаж' => 6, 'номер' => 714, 'площадь' => 34.2, 'вид' => 'Горы', 'цена_м2' => 1400, 'общая_сумма' => 47880, 'статус' => 'Свободный'],
    ['этаж' => 6, 'номер' => 715, 'площадь' => 34.6, 'вид' => 'Горы', 'цена_м2' => 1400, 'общая_сумма' => 48440, 'статус' => 'Свободный'],
    ['этаж' => 6, 'номер' => 716, 'площадь' => 34.6, 'вид' => 'Горы', 'цена_м2' => 1400, 'общая_сумма' => 48440, 'статус' => 'Свободный'],
    ['этаж' => 6, 'номер' => 717, 'площадь' => 34.2, 'вид' => 'Горы', 'цена_м2' => 1400, 'общая_сумма' => 47880, 'статус' => 'Свободный'],
    ['этаж' => 6, 'номер' => 718, 'площадь' => 34.8, 'вид' => 'Горы', 'цена_м2' => 1400, 'общая_сумма' => 48720, 'статус' => 'Свободный'],
    ['этаж' => 6, 'номер' => 719, 'площадь' => 67.6, 'вид' => 'Горы', 'цена_м2' => 1400, 'общая_сумма' => 94640, 'статус' => 'Свободный'],
    ['этаж' => 6, 'номер' => 720, 'площадь' => 59.0, 'вид' => 'Море&Горы', 'цена_м2' => 1900, 'общая_сумма' => 112090, 'статус' => 'Свободный'],
    ['этаж' => 6, 'номер' => 721, 'площадь' => 43.0, 'вид' => 'Море&Горы', 'цена_м2' => 1900, 'общая_сумма' => 81700, 'статус' => 'Свободный'],
];

// ====== ФУНКЦИЯ ФИЛЬТРАЦИИ ======
function searchApartments($params, $apartments) {
    $offers = [];
    foreach ($apartments as $apt) {
        if ($apt['статус'] !== 'Свободный') continue;
        if (isset($params['view']) && mb_strtolower($params['view']) !== mb_strtolower($apt['вид'])) continue;
        if (isset($params['area_min']) && $apt['площадь'] < $params['area_min']) continue;
        if (isset($params['area_max']) && $apt['площадь'] > $params['area_max']) continue;
        $offers[] = $apt;
    }
    return $offers;
}

// ====== ФУНКЦИИ ДЛЯ СОСТОЯНИЯ ПОЛЬЗОВАТЕЛЯ ======
function getUserState($chat_id) {
    $file = __DIR__ . "/user_states/{$chat_id}.json";
    if (!file_exists($file)) return [];
    return json_decode(file_get_contents($file), true);
}
function saveUserState($chat_id, $state) {
    if (!file_exists(__DIR__ . '/user_states')) mkdir(__DIR__ . '/user_states');
    file_put_contents(__DIR__ . "/user_states/{$chat_id}.json", json_encode($state));
}

// ====== ОСНОВНОЙ КОД ======
$token = getenv('TELEGRAM_TOKEN');
$content = file_get_contents("php://input");
$update = json_decode($content, true);

if (isset($update["message"])) {
    $chat_id = $update["message"]["chat"]["id"];
    $text = trim($update["message"]["text"]);
    $user_state = getUserState($chat_id);

    if ($text == '/start' || empty($user_state)) {
        $user_state = ['step' => 1];
        saveUserState($chat_id, $user_state);
        $reply = "Привет! Это Сергей Корнаухов, я брокер по недвижимости в Батуми. Давай подберем тебе лучшую квартиру! Для себя или для сдачи?";
    } else {
        switch ($user_state['step']) {
            case 1:
                $user_state['purpose'] = $text;
                $reply = "Какой вид интересует — море или город?";
                $user_state['step'] = 2;
                break;
            case 2:
                $user_state['view'] = $text;
                $reply = "Минимальная площадь? (например: 30)";
                $user_state['step'] = 3;
                break;
            case 3:
                $user_state['area_min'] = (float)$text;
                $reply = "Максимальная площадь?";
                $user_state['step'] = 4;
                break;
            case 4:
                $user_state['area_max'] = (float)$text;
                $offers = searchApartments($user_state, $apartments);
                if (count($offers) === 0) {
                    $reply = "К сожалению, подходящих вариантов нет. Могу подобрать что-то индивидуально, напишите ваши пожелания!";
                } else {
                    $reply = "Вот подходящие варианты:\n";
                    foreach (array_slice($offers, 0, 3) as $of) {
                        $reply .= "Этаж: {$of['этаж']}, №: {$of['номер']}, Площадь: {$of['площадь']} м², Вид: {$of['вид']}, Цена/м²: \${$of['цена_м2']}, Всего: \${$of['общая_сумма']}\n";
                    }
                }
                $user_state = []; // Сбросить состояние для нового запроса
                break;
        }
        saveUserState($chat_id, $user_state);
    }
    file_get_contents("https://api.telegram.org/bot$token/sendMessage?" . http_build_query([
        'chat_id' => $chat_id,
        'text' => $reply
    ]));
}
