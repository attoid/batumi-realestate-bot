<?php
error_reporting(E_ALL);
ini_set('display_errors', 1);

$openai_key = getenv('OPENAI_API_KEY');
$token = getenv('TELEGRAM_TOKEN');

// ====== БАЗА КВАРТИР ======
$apartments = [
    ['этаж' => 2, 'номер' => 311, 'площадь' => 106.1, 'вид' => 'Море&Горы', 'цена_м2' => 1400, 'общая_сумма' => 148540, 'статус' => 'Свободный'],
    ['этаж' => 2, 'номер' => 319, 'площадь' => 67.6, 'вид' => 'Горы', 'цена_м2' => 1000, 'общая_сумма' => 67600, 'статус' => 'Свободный'],
    ['этаж' => 2, 'номер' => 306, 'площадь' => 36.6, 'вид' => 'Море', 'цена_м2' => 1450, 'общая_сумма' => 53070, 'статус' => 'Свободный'],
    ['этаж' => 3, 'номер' => 419, 'площадь' => 67.6, 'вид' => 'Горы', 'цена_м2' => 1100, 'общая_сумма' => 74360, 'статус' => 'Свободный'],
    ['этаж' => 3, 'номер' => 412, 'площадь' => 50.3, 'вид' => 'Горы', 'цена_м2' => 1100, 'общая_сумма' => 55330, 'статус' => 'Свободный'],
    ['этаж' => 4, 'номер' => 511, 'площадь' => 106.1, 'вид' => 'Море&Горы', 'цена_м2' => 1650, 'общая_сумма' => 175065, 'статус' => 'Свободный'],
    ['этаж' => 4, 'номер' => 504, 'площадь' => 56.7, 'вид' => 'Море', 'цена_м2' => 1700, 'общая_сумма' => 96390, 'статус' => 'Свободный'],
    ['этаж' => 4, 'номер' => 503, 'площадь' => 56.5, 'вид' => 'Море', 'цена_м2' => 1700, 'общая_сумма' => 96050, 'статус' => 'Свободный'],
    ['этаж' => 4, 'номер' => 519, 'площадь' => 67.6, 'вид' => 'Горы', 'цена_м2' => 1200, 'общая_сумма' => 81120, 'статус' => 'Свободный'],
    ['этаж' => 4, 'номер' => 508, 'площадь' => 37.6, 'вид' => 'Горы', 'цена_м2' => 1850, 'общая_сумма' => 69560, 'статус' => 'Свободный'],
    ['этаж' => 509, 'номер' => 309, 'площадь' => 36.3, 'вид' => 'Море', 'цена_м2' => 1850, 'общая_сумма' => 67110, 'статус' => 'Свободный'],
    ['этаж' => 4, 'номер' => 518, 'площадь' => 34.8, 'вид' => 'Горы', 'цена_м2' => 1200, 'общая_сумма' => 41760, 'статус' => 'Свободный'],
    ['этаж' => 4, 'номер' => 516, 'площадь' => 34.6, 'вид' => 'Горы', 'цена_м2' => 1200, 'общая_сумма' => 41520, 'статус' => 'Свободный'],
    ['этаж' => 4, 'номер' => 514, 'площадь' => 34.2, 'вид' => 'Горы', 'цена_м2' => 1200, 'общая_сумма' => 41040, 'статус' => 'Свободный'],
    ['этаж' => 4, 'номер' => 517, 'площадь' => 34.2, 'вид' => 'Горы', 'цена_м2' => 1200, 'общая_сумма' => 41040, 'статус' => 'Свободный'],
    ['этаж' => 4, 'номер' => 513, 'площадь' => 33.7, 'вид' => 'Горы', 'цена_м2' => 1200, 'общая_сумма' => 40440, 'статус' => 'Свободный'],
    ['этаж' => 5, 'номер' => 611, 'площадь' => 106.1, 'вид' => 'Море&Горы', 'цена_м2' => 1800, 'общая_сумма' => 190980, 'статус' => 'Свободный'],
    ['этаж' => 5, 'номер' => 619, 'площадь' => 67.6, 'вид' => 'Горы', 'цена_м2' => 1300, 'общая_сумма' => 87880, 'статус' => 'Свободный'],
    ['этаж' => 5, 'номер' => 615, 'площадь' => 33.0, 'вид' => 'Горы', 'цена_м2' => 1300, 'общая_сумма' => 42900, 'статус' => 'Свободный'],
    ['этаж' => 5, 'номер' => 616, 'площадь' => 34.2, 'вид' => 'Горы', 'цена_м2' => 1350, 'общая_сумма' => 46170, 'статус' => 'Свободный'],
    ['этаж' => 5, 'номер' => 614, 'площадь' => 34.2, 'вид' => 'Горы', 'цена_м2' => 1350, 'общая_сумма' => 46170, 'статус' => 'Свободный'],
    ['этаж' => 5, 'номер' => 617, 'площадь' => 34.2, 'вид' => 'Горы', 'цена_м2' => 1350, 'общая_сумма' => 44640, 'статус' => 'Свободный'],
    ['этаж' => 5, 'номер' => 613, 'площадь' => 33.7, 'вид' => 'Горы', 'цена_м2' => 1300, 'общая_сумма' => 43810, 'статус' => 'Свободный'],
    ['этаж' => 5, 'номер' => 614, 'площадь' => 34.2, 'вид' => 'Горы', 'цена_м2' => 1300, 'общая_сумма' => 44460, 'статус' => 'Свободный'],
    ['этаж' => 5, 'номер' => 615, 'площадь' => 34.6, 'вид' => 'Горы', 'цена_м2' => 1300, 'общая_сумма' => 44980, 'статус' => 'Свободный'],
    ['этаж' => 5, 'номер' => 616, 'площадь' => 34.6, 'вид' => 'Горы', 'цена_м2' => 1300, 'общая_сумма' => 44980, 'статус' => 'Свободный'],
    ['этаж' => 5, 'номер' => 617, 'площадь' => 34.2, 'вид' => 'Горы', 'цена_м2' => 1300, 'общая_сумма' => 44460, 'статус' => 'Свободный'],
    ['этаж' => 5, 'номер' => 618, 'площадь' => 34.8, 'вид' => 'Горы', 'цена_м2' => 1300, 'общая_сумма' => 45420, 'статус' => 'Свободный'],
    ['этаж' => 5, 'номер' => 619, 'площадь' => 67.6, 'вид' => 'Горы', 'цена_м2' => 1300, 'общая_сумма' => 87880, 'статус' => 'Свободный'],
    ['этаж' => 6, 'номер' => 711, 'площадь' => 106.1, 'вид' => 'Море&Горы', 'цена_м2' => 1900, 'общая_сумма' => 201590, 'статус' => 'Свободный'],
    ['этаж' => 6, 'номер' => 712, 'площадь' => 50.3, 'вид' => 'Горы', 'цена_м2' => 1400, 'общая_сумма' => 70240, 'статус' => 'Свободный'],
    ['этаж' => 6, 'номер' => 713, 'площадь' => 33.7, 'вид' => 'Горы', 'цена_м2' => 1400, 'общая_сумма' => 47280, 'статус' => 'Свободный'],
    ['этаж' => 6, 'номер' => 714, 'площадь' => 34.2, 'вид' => 'Горы', 'цена_м2' => 1400, 'общая_сумма' => 47880, 'статус' => 'Свободный'],
    ['этаж' => 6, 'номер' => 715, 'площадь' => 34.6, 'вид' => 'Горы', 'цена_м2' => 1400, 'общая_сумма' => 48440, 'статус' => 'Свободный'],
    ['этаж' => 6, 'номер' => 716, 'площадь' => 34.6, 'вид' => 'Горы', 'цена_м2' => 1400, 'общая_сумма' => 48440, 'статус' => 'Свободный'],
    ['этаж' => 6, 'номер' => 717, 'площадь' => 34.2, 'вид' => 'Горы', 'цена_м2' => 1400, 'общая_сумма' => 47880, 'статус' => 'Свободный'],
    ['этаж' => 6, 'номер' => 718, 'площадь' => 34.8, 'вид' => 'Горы', 'цена_м2' => 1400, 'общая_сумма' => 48720, 'статус' => 'Свободный'],
    ['этаж' => 6, 'номер' => 719, 'площадь' => 67.6, 'вид' => 'Горы', 'цена_м2' => 1400, 'общая_сумма' => 94640, 'статус' => 'Свободный'],
    ['этаж' => 6, 'номер' => 720, 'площадь' => 59.0, 'вид' => 'Море&Горы', 'цена_м2' => 1900, 'общая_сумма' => 112090, 'статус' => 'Свободный'],
    ['этаж' => 6, 'номер' => 721, 'площадь' => 43.0, 'вид' => 'Море&Горы', 'цена_м2' => 1900, 'общая_сумма' => 81700, 'статус' => 'Свободный'],
];

// ====== СТАТИСТИКА ПО БАЗЕ ======
$studio_count = 0;
$studio_min_price = null;
$studio_max_price = null;
foreach ($apartments as $a) {
    if ($a['площадь'] <= 40) {
        $studio_count++;
        if (is_null($studio_min_price) || $a['общая_сумма'] < $studio_min_price) $studio_min_price = $a['общая_сумма'];
        if (is_null($studio_max_price) || $a['общая_сумма'] > $studio_max_price) $studio_max_price = $a['общая_сумма'];
    }
}
$base_stats = "В базе сейчас " . count($apartments) . " квартир, из них студий — $studio_count, цены студий: от \$$studio_min_price до \$$studio_max_price.";

// ====== ФУНКЦИИ ИСТОРИИ ЧАТА ======
function get_chat_history($chat_id) {
    $file = __DIR__ . "/history/{$chat_id}.json";
    if (!file_exists($file)) return [];
    return json_decode(file_get_contents($file), true);
}
function save_chat_history($chat_id, $history) {
    if (!file_exists(__DIR__ . '/history')) mkdir(__DIR__ . '/history', 0777, true);
    file_put_contents(__DIR__ . "/history/{$chat_id}.json", json_encode($history, JSON_UNESCAPED_UNICODE));
}

// ====== GPT ФУНКЦИЯ ======
function ask_gpt($messages, $openai_key) {
    $data = [
        "model" => "gpt-4o",
        "messages" => $messages,
        "max_tokens" => 400,
        "temperature" => 0.5
    ];
    $ch = curl_init("https://api.openai.com/v1/chat/completions");
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    curl_setopt($ch, CURLOPT_HTTPHEADER, [
        "Content-Type: application/json",
        "Authorization: Bearer $openai_key"
    ]);
    curl_setopt($ch, CURLOPT_POST, true);
    curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($data));
    $result = curl_exec($ch);
    curl_close($ch);

    $response = json_decode($result, true);
    return $response['choices'][0]['message']['content'] ?? "Извините, не удалось получить ответ от ИИ.";
}

// ====== ОСНОВНОЙ КОД ======
$content = file_get_contents("php://input");
$update = json_decode($content, true);

if (isset($update["message"])) {
    $chat_id = $update["message"]["chat"]["id"];
    $user_message = trim($update["message"]["text"]);
    $user_name = $update["message"]["from"]["first_name"] ?? "";
    $user_id = $update["message"]["from"]["id"];

    // ====== ПРОВЕРКА ПОДПИСКИ ======
    $channel = "@smkornaukhovv";
    $check_url = "https://api.telegram.org/bot$token/getChatMember?chat_id=$channel&user_id=$user_id";
    $check_result = json_decode(file_get_contents($check_url), true);
    $is_member = false;
    if (isset($check_result["result"]["status"])) {
        $status = $check_result["result"]["status"];
        // 'member', 'creator', 'administrator' — подписан
        if (in_array($status, ["member", "administrator", "creator"])) {
            $is_member = true;
        }
    }
    if (!$is_member) {
        file_get_contents("https://api.telegram.org/bot$token/sendMessage?" . http_build_query([
            'chat_id' => $chat_id,
            'text' => "Для продолжения подпишись на канал 👉 @smkornaukhovv, а потом нажми /start"
        ]));
        exit;
    }

    // ====== ПРИВЕТСТВИЕ (ТОЛЬКО ПРИ ПЕРВОМ ОБРАЩЕНИИ) ======
    $history = get_chat_history($chat_id);
    if (empty($history)) {
        file_get_contents("https://api.telegram.org/bot$token/sendMessage?" . http_build_query([
            'chat_id' => $chat_id,
            'text' => "Привет, $user_name! Рад видеть тебя, сейчас найду лучший вариант квартиры под твои цели. 😉"
        ]));
    }

    // ====== СФОРМИРУЙ БАЗУ ДЛЯ ПРОМПТА ======
    $base_info = "";
    foreach ($apartments as $a) {
        $base_info .= "Этаж: {$a['этаж']}, №: {$a['номер']}, Площадь: {$a['площадь']} м², Вид: {$a['вид']}, Цена/м²: \${$a['цена_м2']}, Всего: \${$a['общая_сумма']}, Статус: {$a['статус']}\n";
    }

    // ====== SYSTEM PROMPT (ОБНОВЛЕННЫЙ) ======
    $messages = [
        [
            "role" => "system",
            "content" =>
"Ты — умный, дерзкий и харизматичный AI-консультант Сергея Корнаухова, 29 лет, брокера по недвижимости в Батуми (опыт с ноября 2023).

Твоя специализация — подбор недвижимости по районам:
— Махинджаури: ЖК Thalassa Group, Next Collection, Kolos, A Sector, Mziuri.
— Новый Бульвар: Ande Metropolis, Summer365, Real Palace Blue, Symbol, Artex, SkuLuxe.
— Старый город: Modern Ultra.

Если клиент спрашивает про район, расскажи чем районы отличаются и предложи варианты по этим объектам. По Махинджаури — акцент на Thalassa Group.

**Акционные квартиры (№319, 412, 514) — объясни две опции:**
1. Обычная цена + рассрочка до 18 мес. при 30% взносе:
   — №319: \$67,000  
   — №412: \$55,330  
   — №514: \$40,040
2. Акционная цена только при полной оплате одним платежом (без рассрочки):
   — №319: \$54,080  
   — №412: \$44,264  
   — №514: \$32,832

**Вопрос:** Что интереснее — купить сразу по спеццене или оформить рассрочку на 18 мес?

Твои суперспособности:
— мгновенно определять формат квартиры по площади (до 37 м² — студия; 37–55 м² — 1+1; 55–80 м² — 2+1; >80 м² — 3+1), объясняй просто.
— фильтровать свою базу и объяснять выгоды каждого района и ЖК.
— кратко, с юмором, остро, дружелюбно.
— если пользователь не знает, что хочет, предлагай 2-3 варианта на выбор и помогай вопросами.
— спрашивай только то, что реально нужно: район, площадь, бюджет, рассрочка, сколько комнат, первый взнос, комфортный платёж.

Если денег не хватает — предложи рассчитать рассрочку (20% взнос, остальное — до 18 мес.) или ипотеку (формула $P = $S * ($r * pow(1 + $r, $n)) / (pow(1 + $r, $n) - 1)).

Основные условия:
— первый взнос от 20%, рассрочка без процентов до 10 мес, акционные варианты — до 18 мес при 30% взносе; оплата на счёт застройщика; бронь 2 недели $100, задаток $1000 на месяц.
— Помогаешь с ремонтом, сопровождением, оформлением сделки, ипотекой через BasisBank.

Точка на карте: https://maps.app.goo.gl/MSoSUbvZF8z3c3639?g_st=ipc

Если спросят про дом Thalassa: 'ЖК Thalassa Group — газ, бассейн, спортзал, сдача в этом году, 135 квартир, надёжный застройщик.'

Если спрашивают акции — объясни две опции (см. выше), уточни про рассрочку или платёж сразу.

$base_stats
Вот база квартир:
$base_info
"
        ]
    ];

    // ====== ИСТОРИЯ ЧАТА ======
    foreach ($history as $msg) {
        $messages[] = $msg;
    }

    // ====== ДОБАВЛЯЕМ НОВОЕ СООБЩЕНИЕ ======
    $messages[] = ["role" => "user", "content" => $user_message];

    // ====== GPT-ЗАПРОС ======
    $answer = ask_gpt($messages, $openai_key);

    // ====== СОХРАНЯЕМ ИСТОРИЮ ======
    $history[] = ["role" => "user", "content" => $user_message];
    $history[] = ["role" => "assistant", "content" => $answer];
    save_chat_history($chat_id, $history);

    // ====== ОТПРАВЛЯЕМ ОТВЕТ ======
    file_get_contents("https://api.telegram.org/bot$token/sendMessage?" . http_build_query([
        'chat_id' => $chat_id,
        'text' => $answer
    ]));
}
