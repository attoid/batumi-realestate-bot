<?php
echo "Бот живой!";

$openai_key = getenv('OPENAI_API_KEY');
$token = getenv('TELEGRAM_TOKEN');

// ====== БАЗА КВАРТИР ======
// ====== БАЗА КВАРТИР ======
$apartments = [
    ['этаж' => 2, 'номер' => 311, 'площадь' => 106.1, 'вид' => 'Море&Горы', 'цена_м2' => 1400, 'общая_сумма' => 148540, 'статус' => 'Свободный'],
    ['этаж' => 2, 'номер' => 319, 'площадь' => 67.6, 'вид' => 'Горы', 'цена_м2' => 1000, 'общая_сумма' => 67600, 'статус' => 'Свободный'],
    ['этаж' => 2, 'номер' => 306, 'площадь' => 36.6, 'вид' => 'Море', 'цена_м2' => 1450, 'общая_сумма' => 53070, 'статус' => 'Свободный'],
    ['этаж' => 3, 'номер' => 419, 'площадь' => 67.6, 'вид' => 'Горы', 'цена_м2' => 1100, 'общая_сумма' => 74360, 'статус' => 'Свободный'],
    ['этаж' => 3, 'номер' => 412, 'площадь' => 50.3, 'вид' => 'Горы', 'цена_м2' => 1100, 'общая_сумма' => 55330, 'статус' => 'Свободный'],
    ['этаж' => 4, 'номер' => 511, 'площадь' => 106.1, 'вид' => 'Море&Горы', 'цена_м2' => 1650, 'общая_сумма' => 175065, 'статус' => 'Свободный'],
    ['этаж' => 4, 'номер' => 504, 'площадь' => 56.7, 'вид' => 'Море', 'цена_м2' => 1700, 'общая_сумма' => 96390, 'статус' => 'Свободный'],
    ['этаж' => 4, 'номер' => 503, 'площадь' => 56.5, 'вид' => 'Море', 'цена_м2' => 1700, 'общая_сумма' => 96050, 'статус' => 'Свободный'],
    ['этаж' => 4, 'номер' => 519, 'площадь' => 67.6, 'вид' => 'Горы', 'цена_м2' => 1200, 'общая_сумма' => 81120, 'статус' => 'Свободный'],
    ['этаж' => 4, 'номер' => 508, 'площадь' => 37.6, 'вид' => 'Горы', 'цена_м2' => 1850, 'общая_сумма' => 69560, 'статус' => 'Свободный'],
    ['этаж' => 509, 'номер' => 309, 'площадь' => 36.3, 'вид' => 'Море', 'цена_м2' => 1850, 'общая_сумма' => 67110, 'статус' => 'Свободный'],
    ['этаж' => 4, 'номер' => 518, 'площадь' => 34.8, 'вид' => 'Горы', 'цена_м2' => 1200, 'общая_сумма' => 41760, 'статус' => 'Свободный'],
    ['этаж' => 4, 'номер' => 516, 'площадь' => 34.6, 'вид' => 'Горы', 'цена_м2' => 1200, 'общая_сумма' => 41520, 'статус' => 'Свободный'],
    ['этаж' => 4, 'номер' => 514, 'площадь' => 34.2, 'вид' => 'Горы', 'цена_м2' => 1200, 'общая_сумма' => 41040, 'статус' => 'Свободный'],
    ['этаж' => 4, 'номер' => 517, 'площадь' => 34.2, 'вид' => 'Горы', 'цена_м2' => 1200, 'общая_сумма' => 41040, 'статус' => 'Свободный'],
    ['этаж' => 4, 'номер' => 513, 'площадь' => 33.7, 'вид' => 'Горы', 'цена_м2' => 1200, 'общая_сумма' => 40440, 'статус' => 'Свободный'],
    ['этаж' => 5, 'номер' => 611, 'площадь' => 106.1, 'вид' => 'Море&Горы', 'цена_м2' => 1800, 'общая_сумма' => 190980, 'статус' => 'Свободный'],
    ['этаж' => 5, 'номер' => 619, 'площадь' => 67.6, 'вид' => 'Горы', 'цена_м2' => 1300, 'общая_сумма' => 87880, 'статус' => 'Свободный'],
    ['этаж' => 5, 'номер' => 615, 'площадь' => 33.0, 'вид' => 'Горы', 'цена_м2' => 1300, 'общая_сумма' => 42900, 'статус' => 'Свободный'],
    ['этаж' => 5, 'номер' => 616, 'площадь' => 34.2, 'вид' => 'Горы', 'цена_м2' => 1350, 'общая_сумма' => 46170, 'статус' => 'Свободный'],
    ['этаж' => 5, 'номер' => 614, 'площадь' => 34.2, 'вид' => 'Горы', 'цена_м2' => 1350, 'общая_сумма' => 46170, 'статус' => 'Свободный'],
    ['этаж' => 5, 'номер' => 617, 'площадь' => 34.2, 'вид' => 'Горы', 'цена_м2' => 1350, 'общая_сумма' => 44640, 'статус' => 'Свободный'],
    ['этаж' => 5, 'номер' => 613, 'площадь' => 33.7, 'вид' => 'Горы', 'цена_м2' => 1300, 'общая_сумма' => 43810, 'статус' => 'Свободный'],
    ['этаж' => 5, 'номер' => 614, 'площадь' => 34.2, 'вид' => 'Горы', 'цена_м2' => 1300, 'общая_сумма' => 44460, 'статус' => 'Свободный'],
    ['этаж' => 5, 'номер' => 615, 'площадь' => 34.6, 'вид' => 'Горы', 'цена_м2' => 1300, 'общая_сумма' => 44980, 'статус' => 'Свободный'],
    ['этаж' => 5, 'номер' => 616, 'площадь' => 34.6, 'вид' => 'Горы', 'цена_м2' => 1300, 'общая_сумма' => 44980, 'статус' => 'Свободный'],
    ['этаж' => 5, 'номер' => 617, 'площадь' => 34.2, 'вид' => 'Горы', 'цена_м2' => 1300, 'общая_сумма' => 44460, 'статус' => 'Свободный'],
    ['этаж' => 5, 'номер' => 618, 'площадь' => 34.8, 'вид' => 'Горы', 'цена_м2' => 1300, 'общая_сумма' => 45420, 'статус' => 'Свободный'],
    ['этаж' => 5, 'номер' => 619, 'площадь' => 67.6, 'вид' => 'Горы', 'цена_м2' => 1300, 'общая_сумма' => 87880, 'статус' => 'Свободный'],
    ['этаж' => 6, 'номер' => 711, 'площадь' => 106.1, 'вид' => 'Море&Горы', 'цена_м2' => 1900, 'общая_сумма' => 201590, 'статус' => 'Свободный'],
    ['этаж' => 6, 'номер' => 712, 'площадь' => 50.3, 'вид' => 'Горы', 'цена_м2' => 1400, 'общая_сумма' => 70240, 'статус' => 'Свободный'],
    ['этаж' => 6, 'номер' => 713, 'площадь' => 33.7, 'вид' => 'Горы', 'цена_м2' => 1400, 'общая_сумма' => 47280, 'статус' => 'Свободный'],
    ['этаж' => 6, 'номер' => 714, 'площадь' => 34.2, 'вид' => 'Горы', 'цена_м2' => 1400, 'общая_сумма' => 47880, 'статус' => 'Свободный'],
    ['этаж' => 6, 'номер' => 715, 'площадь' => 34.6, 'вид' => 'Горы', 'цена_м2' => 1400, 'общая_сумма' => 48440, 'статус' => 'Свободный'],
    ['этаж' => 6, 'номер' => 716, 'площадь' => 34.6, 'вид' => 'Горы', 'цена_м2' => 1400, 'общая_сумма' => 48440, 'статус' => 'Свободный'],
    ['этаж' => 6, 'номер' => 717, 'площадь' => 34.2, 'вид' => 'Горы', 'цена_м2' => 1400, 'общая_сумма' => 47880, 'статус' => 'Свободный'],
    ['этаж' => 6, 'номер' => 718, 'площадь' => 34.8, 'вид' => 'Горы', 'цена_м2' => 1400, 'общая_сумма' => 48720, 'статус' => 'Свободный'],
    ['этаж' => 6, 'номер' => 719, 'площадь' => 67.6, 'вид' => 'Горы', 'цена_м2' => 1400, 'общая_сумма' => 94640, 'статус' => 'Свободный'],
    ['этаж' => 6, 'номер' => 720, 'площадь' => 59.0, 'вид' => 'Море&Горы', 'цена_м2' => 1900, 'общая_сумма' => 112090, 'статус' => 'Свободный'],
    ['этаж' => 6, 'номер' => 721, 'площадь' => 43.0, 'вид' => 'Море&Горы', 'цена_м2' => 1900, 'общая_сумма' => 81700, 'статус' => 'Свободный'],
];
function ask_gpt($prompt, $openai_key) {
    $data = [
        "model" => "gpt-4o",
$messages = [
    ["role" => "system", "content" => "Твои правила..."],
    ["role" => "user", "content" => "Я не был в Батуми"],
    ["role" => "assistant", "content" => "Тогда расскажу, как обычно выбирают..."],
    ["role" => "user", "content" => "А что лучше для сдачи?"],
    ["role" => "assistant", "content" => "Для сдачи обычно выбирают квартиры у моря..."],
    ["role" => "user", "content" => $prompt] // <-- последнее сообщение пользователя
];
            ],
            ["role" => "user", "content" => $prompt]
        ],
        "max_tokens" => 400,
        "temperature" => 0.5
    ]; // вот тут закрывается $data

    $ch = curl_init("https://api.openai.com/v1/chat/completions");
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    curl_setopt($ch, CURLOPT_HTTPHEADER, [
        "Content-Type: application/json",
        "Authorization: Bearer $openai_key"
    ]);
    curl_setopt($ch, CURLOPT_POST, true);
    curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($data));
    $result = curl_exec($ch);
    curl_close($ch);

    $response = json_decode($result, true);
    return $response['choices'][0]['message']['content'] ?? "Извините, не удалось получить ответ от ИИ.";
}

// ====== ОСНОВНОЙ КОД ======
$content = file_get_contents("php://input");
$update = json_decode($content, true);

if (isset($update["message"])) {
    $chat_id = $update["message"]["chat"]["id"];
    $text = trim($update["message"]["text"]);

    // --- Формируем промпт с базой квартир
    $base_prompt = "Вот база квартир в наличии:\n";
    foreach ($apartments as $a) {
        $base_prompt .= "Этаж: {$a['этаж']}, №: {$a['номер']}, Площадь: {$a['площадь']} м², Вид: {$a['вид']}, Цена/м²: \${$a['цена_м2']}, Всего: \${$a['общая_сумма']}, Статус: {$a['статус']}\n";
    }
    $full_prompt = $base_prompt . "\nПользователь пишет: " . $text . "\nНе используй длинные шаблонные вступления, говори сразу по делу и коротко, дружелюбно. Если пользователь не знает, чего хочет — предложи пару вариантов разного типа и задай короткий уточняющий вопрос.";

    $answer = ask_gpt($full_prompt, $openai_key);

    file_get_contents("https://api.telegram.org/bot$token/sendMessage?" . http_build_query([
        'chat_id' => $chat_id,
        'text' => $answer
    ]));
}
