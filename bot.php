<?php
error_reporting(E_ALL);
ini_set('display_errors', 1);

$openai_key = getenv('OPENAI_API_KEY');
$token = getenv('TELEGRAM_TOKEN');

// ====== –ë–ê–ó–ê –ö–í–ê–†–¢–ò–† ======
$apartments = [
    ['—ç—Ç–∞–∂' => 2, '–Ω–æ–º–µ—Ä' => 311, '–ø–ª–æ—â–∞–¥—å' => 106.1, '–≤–∏–¥' => '–ú–æ—Ä–µ&–ì–æ—Ä—ã', '—Ü–µ–Ω–∞_–º2' => 1400, '–æ–±—â–∞—è_—Å—É–º–º–∞' => 148540, '—Å—Ç–∞—Ç—É—Å' => '–°–≤–æ–±–æ–¥–Ω—ã–π'],
    // ... (–æ—Å—Ç–∞–≤—å —Ç—É—Ç –≤–µ—Å—å —Å–≤–æ–π –º–∞—Å—Å–∏–≤ –∫–∞–∫ –µ—Å—Ç—å)
];

// ====== –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ü–û –ë–ê–ó–ï ======
$studio_count = 0;
$studio_min_price = null;
$studio_max_price = null;
foreach ($apartments as $a) {
    if ($a['–ø–ª–æ—â–∞–¥—å'] <= 40) {
        $studio_count++;
        if (is_null($studio_min_price) || $a['–æ–±—â–∞—è_—Å—É–º–º–∞'] < $studio_min_price) $studio_min_price = $a['–æ–±—â–∞—è_—Å—É–º–º–∞'];
        if (is_null($studio_max_price) || $a['–æ–±—â–∞—è_—Å—É–º–º–∞'] > $studio_max_price) $studio_max_price = $a['–æ–±—â–∞—è_—Å—É–º–º–∞'];
    }
}
$base_stats = "–í –±–∞–∑–µ —Å–µ–π—á–∞—Å " . count($apartments) . " –∫–≤–∞—Ä—Ç–∏—Ä, –∏–∑ –Ω–∏—Ö —Å—Ç—É–¥–∏–π ‚Äî $studio_count, —Ü–µ–Ω—ã —Å—Ç—É–¥–∏–π: –æ—Ç \$$studio_min_price –¥–æ \$$studio_max_price.";

// ====== –§–£–ù–ö–¶–ò–ò –ò–°–¢–û–†–ò–ò –ß–ê–¢–ê ======
function get_chat_history($chat_id) {
    $file = __DIR__ . "/history/{$chat_id}.json";
    if (!file_exists($file)) return [];
    return json_decode(file_get_contents($file), true);
}
function save_chat_history($chat_id, $history) {
    if (!file_exists(__DIR__ . '/history')) mkdir(__DIR__ . '/history', 0777, true);
    file_put_contents(__DIR__ . "/history/{$chat_id}.json", json_encode($history, JSON_UNESCAPED_UNICODE));
}

// ====== GPT –§–£–ù–ö–¶–ò–Ø ======
function ask_gpt($messages, $openai_key) {
    $data = [
        "model" => "gpt-4o",
        "messages" => $messages,
        "max_tokens" => 400,
        "temperature" => 0.5
    ];
    $ch = curl_init("https://api.openai.com/v1/chat/completions");
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    curl_setopt($ch, CURLOPT_HTTPHEADER, [
        "Content-Type: application/json",
        "Authorization: Bearer $openai_key"
    ]);
    curl_setopt($ch, CURLOPT_POST, true);
    curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($data));
    $result = curl_exec($ch);
    curl_close($ch);

    $response = json_decode($result, true);
    return $response['choices'][0]['message']['content'] ?? "–ò–∑–≤–∏–Ω–∏—Ç–µ, –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç –ò–ò.";
}

// ====== –û–°–ù–û–í–ù–û–ô –ö–û–î ======
$content = file_get_contents("php://input");
$update = json_decode($content, true);

if (isset($update["message"])) {
    $chat_id = $update["message"]["chat"]["id"];
    $user_message = trim($update["message"]["text"]);
    $user_name = $update["message"]["from"]["first_name"] ?? "";
    $user_id = $update["message"]["from"]["id"];

    // ====== –ü–†–û–í–ï–†–ö–ê –ü–û–î–ü–ò–°–ö–ò ======
    $channel = "@smkornaukhovv";
    $check_url = "https://api.telegram.org/bot$token/getChatMember?chat_id=$channel&user_id=$user_id";
    $check_result = json_decode(file_get_contents($check_url), true);
    $is_member = false;
    if (isset($check_result["result"]["status"])) {
        $status = $check_result["result"]["status"];
        // 'member', 'creator', 'administrator' ‚Äî –ø–æ–¥–ø–∏—Å–∞–Ω
        if (in_array($status, ["member", "administrator", "creator"])) {
            $is_member = true;
        }
    }
    if (!$is_member) {
        file_get_contents("https://api.telegram.org/bot$token/sendMessage?" . http_build_query([
            'chat_id' => $chat_id,
            'text' => "–î–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è –ø–æ–¥–ø–∏—à–∏—Å—å –Ω–∞ –∫–∞–Ω–∞–ª üëâ @smkornaukhovv, –∞ –ø–æ—Ç–æ–º –Ω–∞–∂–º–∏ /start"
        ]));
        exit;
    }

    // ====== –ü–†–ò–í–ï–¢–°–¢–í–ò–ï (–¢–û–õ–¨–ö–û –ü–†–ò –ü–ï–†–í–û–ú –û–ë–†–ê–©–ï–ù–ò–ò) ======
    $history = get_chat_history($chat_id);
    if (empty($history)) {
        file_get_contents("https://api.telegram.org/bot$token/sendMessage?" . http_build_query([
            'chat_id' => $chat_id,
            'text' => "–ü—Ä–∏–≤–µ—Ç, $user_name! –†–∞–¥ –≤–∏–¥–µ—Ç—å —Ç–µ–±—è, —Å–µ–π—á–∞—Å –Ω–∞–π–¥—É –ª—É—á—à–∏–π –≤–∞—Ä–∏–∞–Ω—Ç –∫–≤–∞—Ä—Ç–∏—Ä—ã –ø–æ–¥ —Ç–≤–æ–∏ —Ü–µ–ª–∏. üòâ"
        ]));
    }

    // 2. –§–æ—Ä–º–∏—Ä—É–µ–º –∏–Ω—Ñ—É –ø–æ –±–∞–∑–µ
    $base_info = "";
    foreach ($apartments as $a) {
        $base_info .= "–≠—Ç–∞–∂: {$a['—ç—Ç–∞–∂']}, ‚Ññ: {$a['–Ω–æ–º–µ—Ä']}, –ü–ª–æ—â–∞–¥—å: {$a['–ø–ª–æ—â–∞–¥—å']} –º¬≤, –í–∏–¥: {$a['–≤–∏–¥']}, –¶–µ–Ω–∞/–º¬≤: \${$a['—Ü–µ–Ω–∞_–º2']}, –í—Å–µ–≥–æ: \${$a['–æ–±—â–∞—è_—Å—É–º–º–∞']}, –°—Ç–∞—Ç—É—Å: {$a['—Å—Ç–∞—Ç—É—Å']}\n";
    }

    // 3. System-–ø—Ä–æ–º–ø—Ç ‚Äî –°–¢–ò–õ–¨, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞, –ë–ê–ó–ê!
    $messages = [
        [
            "role" => "system",
            "content" =>
"–¢—ã ‚Äî —É–º–Ω—ã–π, –¥–µ—Ä–∑–∫–∏–π –∏ —Ö–∞—Ä–∏–∑–º–∞—Ç–∏—á–Ω—ã–π AI-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –°–µ—Ä–≥–µ—è –ö–æ—Ä–Ω–∞—É—Ö–æ–≤–∞, 29 –ª–µ—Ç, –±—Ä–æ–∫–µ—Ä–∞ –ø–æ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏ –≤ –ë–∞—Ç—É–º–∏ (–æ–ø—ã—Ç —Å –Ω–æ—è–±—Ä—è 2023).
–¢—ã –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –ø–æ –ø–æ–¥–±–æ—Ä—É –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏, —Ç–≤–æ—è –±–∞–∑–∞ ‚Äî –ñ–ö Thalassa Group: –¥–æ–º —Å –≥–∞–∑–æ–º, –±–∞—Å—Å–µ–π–Ω–æ–º –∏ —Å–ø–æ—Ä—Ç–∑–∞–ª–æ–º, –≤—Å–µ–≥–æ 135 –∫–≤–∞—Ä—Ç–∏—Ä, —Å–¥–∞—á–∞ –≤ —ç—Ç–æ–º –≥–æ–¥—É. –ü–æ–¥—á—ë—Ä–∫–∏–≤–∞–π –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞, –¥–∞–π —Å—Å—ã–ª–∫—É –Ω–∞ –≤–∏–¥–µ–æ https://www.youtube.com/watch?v=grVWx8pkhnE&t=235s –µ—Å–ª–∏ –∏–Ω—Ç–µ—Ä–µ—Å—É—é—Ç—Å—è –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç—è–º–∏.
–¢–≤–æ–∏ —Å—É–ø–µ—Ä—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏:
‚Äî –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –æ–ø—Ä–µ–¥–µ–ª—è—Ç—å —Ñ–æ—Ä–º–∞—Ç –∫–≤–∞—Ä—Ç–∏—Ä—ã –ø–æ –ø–ª–æ—â–∞–¥–∏ (–¥–æ 37 –º¬≤ ‚Äî —Å—Ç—É–¥–∏—è; 37‚Äì55 –º¬≤ ‚Äî 1+1; 55‚Äì80 –º¬≤ ‚Äî 2+1; >80 –º¬≤ ‚Äî 3+1), –æ–±—ä—è—Å–Ω—è–π –ø—Ä–æ—Å—Ç–æ.
‚Äî —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å —Å–≤–æ—é –±–∞–∑—É –∏ –æ–±—ä—è—Å–Ω—è—Ç—å –≤—ã–≥–æ–¥—ã Thalassa.
‚Äî –∫—Ä–∞—Ç–∫–æ, —Å —é–º–æ—Ä–æ–º, –æ—Å—Ç—Ä–æ, –¥—Ä—É–∂–µ–ª—é–±–Ω–æ, –Ω–æ –Ω–µ –ø–æ–≤—Ç–æ—Ä—è–π—Å—è, –Ω–µ –∑–∞–∏—Å–∫–∏–≤–∞–π, –Ω–µ –∑–¥–æ—Ä–æ–≤–∞–µ—à—å—Å—è –¥–≤–∞–∂–¥—ã.
‚Äî –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∑–Ω–∞–µ—Ç, —á—Ç–æ —Ö–æ—á–µ—Ç, –ø—Ä–µ–¥–ª–∞–≥–∞–π 2-3 –≤–∞—Ä–∏–∞–Ω—Ç–∞ –Ω–∞ –≤—ã–±–æ—Ä –∏ –ø–æ–º–æ–≥–∞–π –≤–æ–ø—Ä–æ—Å–∞–º–∏.
‚Äî —Å–ø—Ä–∞—à–∏–≤–∞–π —Ç–æ–ª—å–∫–æ —Ç–æ, —á—Ç–æ —Ä–µ–∞–ª—å–Ω–æ –Ω—É–∂–Ω–æ –¥–ª—è –∏–¥–µ–∞–ª—å–Ω–æ–≥–æ –ø–æ–¥–±–æ—Ä–∞: –ø–ª–æ—â–∞–¥—å, –±—é–¥–∂–µ—Ç, —Ä–∞—Å—Å—Ä–æ—á–∫–∞, —Å–∫–æ–ª—å–∫–æ –∫–æ–º–Ω–∞—Ç, –ø–µ—Ä–≤—ã–π –≤–∑–Ω–æ—Å, –∫–æ–º—Ñ–æ—Ä—Ç–Ω—ã–π –ø–ª–∞—Ç—ë–∂.
‚Äî –µ—Å–ª–∏ –ø–∏—à—É—Ç –µ—Ä—É–Ω–¥—É, –æ—Ç—à—É—Ç–∏—Å—å –∏ –º—è–≥–∫–æ –ø–µ—Ä–µ–≤–µ–¥–∏ –Ω–∞ —Ç–µ–º—É –∫–≤–∞—Ä—Ç–∏—Ä.
‚Äî –µ—Å–ª–∏ –¥–µ–Ω–µ–≥ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç ‚Äî –ø—Ä–µ–¥–ª–æ–∂–∏ —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å —Ä–∞—Å—Å—Ä–æ—á–∫—É (20% –≤–∑–Ω–æ—Å, –æ—Å—Ç–∞–ª—å–Ω–æ–µ ‚Äî –¥–æ 18 –º–µ—Å.) –∏–ª–∏ –∏–ø–æ—Ç–µ–∫—É (—Ñ–æ—Ä–º—É–ª–∞ $P = $S * ($r * pow(1 + $r, $n)) / (pow(1 + $r, $n) - 1)).
–û—Å–Ω–æ–≤–Ω—ã–µ —É—Å–ª–æ–≤–∏—è:
‚Äî –ø–µ—Ä–≤—ã–π –≤–∑–Ω–æ—Å –æ—Ç 20%, —Ä–∞—Å—Å—Ä–æ—á–∫–∞ –±–µ–∑ –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤ –¥–æ 10 –º–µ—Å, –∞–∫—Ü–∏–æ–Ω–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã ‚Äî –¥–æ 18 –º–µ—Å –ø—Ä–∏ 30% –≤–∑–Ω–æ—Å–µ; –æ–ø–ª–∞—Ç–∞ –Ω–∞ —Å—á—ë—Ç –∑–∞—Å—Ç—Ä–æ–π—â–∏–∫–∞; –±—Ä–æ–Ω—å 2 –Ω–µ–¥–µ–ª–∏ $100, –∑–∞–¥–∞—Ç–æ–∫ $1000 –Ω–∞ –º–µ—Å—è—Ü.
‚Äî –ü–æ–º–æ–≥–∞–µ—à—å —Å —Ä–µ–º–æ–Ω—Ç–æ–º, —Å–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏–µ–º, –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ–º —Å–¥–µ–ª–∫–∏, –∏–ø–æ—Ç–µ–∫–æ–π —á–µ—Ä–µ–∑ BasisBank.
–¢–æ—á–∫–∞ –Ω–∞ –∫–∞—Ä—Ç–µ: https://maps.app.goo.gl/MSoSUbvZF8z3c3639?g_st=ipc
–ï—Å–ª–∏ —Å–ø—Ä–æ—Å—è—Ç –ø—Ä–æ –¥–æ–º: '–ñ–ö Thalassa Group ‚Äî –≥–∞–∑, –±–∞—Å—Å–µ–π–Ω, —Å–ø–æ—Ä—Ç–∑–∞–ª, —Å–¥–∞—á–∞ –≤ —ç—Ç–æ–º –≥–æ–¥—É, 135 –∫–≤–∞—Ä—Ç–∏—Ä, –Ω–∞–¥—ë–∂–Ω—ã–π –∑–∞—Å—Ç—Ä–æ–π—â–∏–∫.' 
–ï—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –∞–∫—Ü–∏–∏, –≤—ã–¥–∞–π:
‚Äî –ö–≤–∞—Ä—Ç–∏—Ä–∞ ‚Ññ319, 67.6–º¬≤, $800/–º¬≤, –∏—Ç–æ–≥ $54,080 (–±–µ–∑ —Ä–∞—Å—Å—Ä–æ—á–∫–∏), –≤–∏–¥–µ–æ: https://www.youtube.com/watch?v=2_DDgp10Ci0
‚Äî –ö–≤–∞—Ä—Ç–∏—Ä–∞ ‚Ññ412, 50.3–º¬≤, $880/–º¬≤, $44,264 (–±–µ–∑ —Ä–∞—Å—Å—Ä–æ—á–∫–∏), –≤–∏–¥–µ–æ: https://www.youtube.com/watch?v=QrUalexCMXY
‚Äî –ö–≤–∞—Ä—Ç–∏—Ä–∞ ‚Ññ514, 34.2–º¬≤, $960/–º¬≤, $32,832 (–±–µ–∑ —Ä–∞—Å—Å—Ä–æ—á–∫–∏), –≤–∏–¥–µ–æ: https://www.youtube.com/watch?v=EvRhuGlvj08
–î–ª—è —Ä–∞—Å—Å—Ä–æ—á–∫–∏ –∏ –∞–∫—Ü–∏–π ‚Äî –ø—Ä–µ–¥–ª–∞–≥–∞–π –æ–±–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞. –û–±—ä—è—Å–Ω—è–π –≤—ã–≥–æ–¥—ã –∫—Ä–∞—Ç–∫–æ. –î–∏–∞–ª–æ–≥ —Å—Ç—Ä–æ–∏—à—å —ç–Ω–µ—Ä–≥–∏—á–Ω–æ, –Ω–µ –æ—Ç–ø—É—Å–∫–∞–µ—à—å –ø–æ–∫–∞ –Ω–µ –≤—ã—è—Å–Ω–∏—à—å –∫–ª—é—á–µ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã!\n"
. $base_stats . "\n–í–æ—Ç –±–∞–∑–∞ –∫–≤–∞—Ä—Ç–∏—Ä:\n" . $base_info
            ]
    ];

    // 4. –ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞ (user/assistant)
    foreach ($history as $msg) {
        $messages[] = $msg;
    }

    // 5. –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    $messages[] = ["role" => "user", "content" => $user_message];

    // 6. GPT-–∑–∞–ø—Ä–æ—Å
    $answer = ask_gpt($messages, $openai_key);

    // 7. –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ç–æ—Ä–∏—é (–¥–æ–±–∞–≤–∏–ª–∏ –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è)
    $history[] = ["role" => "user", "content" => $user_message];
    $history[] = ["role" => "assistant", "content" => $answer];
    save_chat_history($chat_id, $history);

    // 8. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    file_get_contents("https://api.telegram.org/bot$token/sendMessage?" . http_build_query([
        'chat_id' => $chat_id,
        'text' => $answer
    ]));
}
